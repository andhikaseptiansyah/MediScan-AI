<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Health Portal Login</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    html {
      height: 100%;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    }

    .card-shadow {
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .scan-frame {
      border: 3px dashed #1e3a8a;
      border-radius: 50%;
      animation: pulse-border 2s infinite;
    }

    @keyframes pulse-border {
      0%, 100% {
        border-color: #1e3a8a;
        opacity: 1;
      }
      50% {
        border-color: #b45309;
        opacity: 0.6;
      }
    }

    .scanning {
      animation: scan-animation 2s ease-in-out;
    }

    @keyframes scan-animation {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }

    .flash-effect {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 9999;
      pointer-events: none;
      animation: flash 0.5s ease-out;
    }

    @keyframes flash {
      0% {
        opacity: 0;
      }
      50% {
        opacity: 0.8;
      }
      100% {
        opacity: 0;
      }
    }

    .countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 120px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      z-index: 100;
      animation: countdown-pulse 1s ease-in-out;
    }

    @keyframes countdown-pulse {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0;
      }
    }

    .checkmark-animation {
      animation: checkmark-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes checkmark-pop {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .confidence-bar {
      transition: width 1s ease-out;
    }

    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .preview-content {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slide-in 0.3s ease-out;
    }

    @keyframes slide-in {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .success-toast {
      background-color: #10b981;
    }

    .error-toast {
      background-color: #ef4444;
    }

    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .slide-enter {
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .slide-exit {
      animation: slideOut 0.5s ease-out;
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(-100%);
        opacity: 0;
      }
    }

    .step-active {
      background-color: white !important;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .step-inactive {
      background-color: rgba(255, 255, 255, 0.3);
    }

    .step-text-active {
      opacity: 1 !important;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app" class="gradient-bg min-h-full flex items-center justify-center p-6"><main id="landingPage" class="w-full max-w-6xl"><div class="text-center mb-8">
     <div class="inline-flex items-center justify-center mb-4">
      <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center shadow-lg">
       <svg class="w-10 h-10 text-blue-900" fill="currentColor" viewbox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z" />
       </svg>
      </div>
     </div>
     <h1 id="mainTitle" class="text-5xl font-bold text-white mb-3">MediScan AI</h1>
     <p id="mainTagline" class="text-xl text-white opacity-90">Your Health, Our Priority</p>
    </div><div class="max-w-3xl mx-auto mb-8">
     <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl p-6">
      <div class="flex items-center justify-between">
       <div class="flex-1 text-center">
        <div id="wizardStep1" class="w-10 h-10 step-active rounded-full flex items-center justify-center mx-auto mb-2 shadow-lg transition-all duration-300"><span id="wizardStep1Text" class="text-blue-900 font-bold">1</span>
        </div>
        <p id="wizardStep1Label" class="text-white text-sm font-medium step-text-active transition-opacity duration-300">Choose Mode</p>
       </div>
       <div id="wizardLine1" class="flex-1 border-t-2 border-white border-opacity-50 mx-4 mt-[-20px]"></div>
       <div class="flex-1 text-center">
        <div id="wizardStep2" class="w-10 h-10 step-inactive rounded-full flex items-center justify-center mx-auto mb-2 transition-all duration-300"><span id="wizardStep2Text" class="text-white font-bold">2</span>
        </div>
        <p id="wizardStep2Label" class="text-white text-sm font-medium opacity-50 transition-opacity duration-300">Enter Details</p>
       </div>
       <div id="wizardLine2" class="flex-1 border-t-2 border-white border-opacity-30 mx-4 mt-[-20px]"></div>
       <div class="flex-1 text-center">
        <div id="wizardStep3" class="w-10 h-10 step-inactive rounded-full flex items-center justify-center mx-auto mb-2 transition-all duration-300"><span id="wizardStep3Text" class="text-white font-bold">3</span>
        </div>
        <p id="wizardStep3Label" class="text-white text-sm font-medium opacity-50 transition-opacity duration-300">Face Scan</p>
       </div>
      </div>
     </div>
    </div><div class="grid md:grid-cols-2 gap-6"><div class="bg-white rounded-3xl card-shadow p-8 transform transition-all duration-300 hover:scale-105 hover:shadow-2xl cursor-pointer" id="loginCard">
      <div class="text-center mb-6">
       <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-100 to-blue-200 rounded-full mb-4">
        <svg class="w-10 h-10 text-blue-900" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
        </svg>
       </div>
       <h2 class="text-3xl font-bold text-gray-800 mb-2">Login</h2>
       <p class="text-gray-600 mb-6">Already have an account? Access your health portal</p>
      </div>
      <div class="space-y-4 mb-6">
       <div class="flex items-center space-x-3 text-gray-700">
        <svg class="w-5 h-5 text-blue-900" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg><span>Quick face recognition</span>
       </div>
       <div class="flex items-center space-x-3 text-gray-700">
        <svg class="w-5 h-5 text-blue-900" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg><span>Secure &amp; encrypted</span>
       </div>
       <div class="flex items-center space-x-3 text-gray-700">
        <svg class="w-5 h-5 text-blue-900" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg><span>Access in seconds</span>
       </div>
      </div><button class="w-full bg-gradient-to-r from-blue-900 to-blue-800 text-white py-4 px-8 rounded-xl font-semibold hover:from-blue-800 hover:to-blue-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"> Continue to Login </button>
     </div><div class="bg-white rounded-3xl card-shadow p-8 transform transition-all duration-300 hover:scale-105 hover:shadow-2xl cursor-pointer" id="registerCardMain">
      <div class="text-center mb-6">
       <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-full mb-4">
        <svg class="w-10 h-10 text-yellow-900" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
        </svg>
       </div>
       <h2 class="text-3xl font-bold text-gray-800 mb-2">Register</h2>
       <p class="text-gray-600 mb-6">New here? Create your account in minutes</p>
      </div>
      <div class="space-y-4 mb-6">
       <div class="flex items-center space-x-3 text-gray-700">
        <svg class="w-5 h-5 text-yellow-900" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg><span>Simple registration</span>
       </div>
       <div class="flex items-center space-x-3 text-gray-700">
        <svg class="w-5 h-5 text-yellow-900" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg><span>Biometric setup</span>
       </div>
       <div class="flex items-center space-x-3 text-gray-700">
        <svg class="w-5 h-5 text-yellow-900" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg><span>Instant activation</span>
       </div>
      </div><button class="w-full bg-gradient-to-r from-yellow-900 to-yellow-800 text-white py-4 px-8 rounded-xl font-semibold hover:from-yellow-800 hover:to-yellow-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"> Create New Account </button>
     </div>
    </div>
   </main><main id="loginPage" class="w-full max-w-6xl hidden">
    <div class="bg-white rounded-3xl card-shadow overflow-hidden"><div class="flex border-b border-gray-200"><button id="loginTab" class="flex-1 py-4 px-6 text-center font-semibold text-blue-900 border-b-4 border-blue-900 bg-blue-50 transition-all">
       <div class="flex items-center justify-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
        </svg><span>Login</span>
       </div></button> <button id="registerTabBtn" class="flex-1 py-4 px-6 text-center font-semibold text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-all">
       <div class="flex items-center justify-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
        </svg><span>Register</span>
       </div></button>
     </div>
     <div class="grid md:grid-cols-2"><div class="bg-gradient-to-br from-blue-900 to-blue-800 p-12 flex flex-col justify-center items-center text-white relative overflow-hidden">
       <div class="absolute top-0 left-0 w-full h-full opacity-10">
        <svg class="w-full h-full" viewbox="0 0 400 400" fill="none"><circle cx="100" cy="100" r="60" fill="white" /> <circle cx="320" cy="280" r="80" fill="white" /> <circle cx="50" cy="350" r="40" fill="white" /> <circle cx="350" cy="50" r="50" fill="white" />
        </svg>
       </div>
       <div class="relative z-10 text-center">
        <div class="mb-8">
         <svg class="w-48 h-48 mx-auto" viewbox="0 0 200 200" fill="none"><circle cx="100" cy="100" r="90" fill="white" opacity="0.2" /> <circle cx="100" cy="70" r="30" fill="white" /> <path d="M70 100 Q70 130 100 150 Q130 130 130 100 L130 90 Q130 85 125 85 L75 85 Q70 85 70 90 Z" fill="white" /> <circle cx="100" cy="65" r="8" fill="#b45309" /> <path d="M92 75 Q100 78 108 75" stroke="#b45309" stroke-width="2" stroke-linecap="round" /> <path d="M85 110 Q85 120 95 125" stroke="white" stroke-width="3" stroke-linecap="round" /> <circle cx="95" cy="128" r="5" fill="white" /> <rect x="145" y="130" width="8" height="20" fill="white" rx="2" /> <rect x="141" y="138" width="16" height="8" fill="white" rx="2" />
         </svg>
        </div>
        <h1 id="appTitle" class="text-4xl font-bold mb-4">Health Portal</h1>
        <p id="appTagline" class="text-lg opacity-90 mb-8">Your Health, Our Priority</p>
        <div class="grid grid-cols-3 gap-4 mt-12">
         <div class="text-center">
          <div class="bg-white bg-opacity-20 rounded-lg p-3 mb-2">
           <svg class="w-8 h-8 mx-auto" fill="white" viewbox="0 0 24 24"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z" />
           </svg>
          </div>
          <p class="text-sm font-medium">Secure</p>
         </div>
         <div class="text-center">
          <div class="bg-white bg-opacity-20 rounded-lg p-3 mb-2">
           <svg class="w-8 h-8 mx-auto" fill="white" viewbox="0 0 24 24"><path d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93s-3.05 7.44-7 7.93v2.02c5.05-.5 9-4.76 9-9.95S18.05 2.55 13 2.05zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" />
           </svg>
          </div>
          <p class="text-sm font-medium">Fast</p>
         </div>
         <div class="text-center">
          <div class="bg-white bg-opacity-20 rounded-lg p-3 mb-2">
           <svg class="w-8 h-8 mx-auto" fill="white" viewbox="0 0 24 24"><path d="M9 11.75A1.25 1.25 0 1 0 9 9a1.25 1.25 0 0 0 0 2.75zm6 0A1.25 1.25 0 1 0 15 9a1.25 1.25 0 0 0 0 2.75zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-.29.02-.58.05-.86 2.36-1.05 4.23-2.98 5.21-5.37C11.07 8.33 14.05 10 17.42 10c.78 0 1.53-.09 2.25-.26.21.71.33 1.47.33 2.26 0 4.41-3.59 8-8 8z" />
           </svg>
          </div>
          <p class="text-sm font-medium">Easy</p>
         </div>
        </div>
       </div>
      </div><div id="loginContent" class="p-12 flex flex-col justify-center">
       <div class="mb-8">
        <h2 id="loginTitle" class="text-3xl font-bold text-gray-800 mb-2">Welcome Back</h2>
        <p class="text-gray-500">Use facial recognition to access your account</p>
       </div>
       <div class="mb-8">
        <div class="flex flex-col items-center py-8">
         <div id="loginScanFrame" class="scan-frame w-56 h-56 flex items-center justify-center mb-6 bg-gradient-to-br from-blue-50 to-blue-100 relative overflow-hidden">
          <div class="absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-blue-900 rounded-tl-full"></div>
          <div class="absolute top-0 right-0 w-12 h-12 border-t-4 border-r-4 border-blue-900 rounded-tr-full"></div>
          <div class="absolute bottom-0 left-0 w-12 h-12 border-b-4 border-l-4 border-blue-900 rounded-bl-full"></div>
          <div class="absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-blue-900 rounded-br-full"></div>
          <video id="loginVideo" class="w-full h-full object-cover rounded-full hidden" autoplay playsinline></video>
          <svg id="loginCameraIcon" class="w-32 h-32 text-blue-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div><div id="loginConfidenceDisplay" class="w-full max-w-sm mb-6 hidden">
          <div class="bg-gray-100 rounded-xl p-4">
           <div class="flex items-center justify-between mb-2"><span class="text-sm font-semibold text-gray-700">Face Match Confidence</span> <span id="loginConfidencePercent" class="text-2xl font-bold text-green-600">98%</span>
           </div>
           <div class="w-full bg-gray-300 rounded-full h-3 overflow-hidden">
            <div id="loginConfidenceBar" class="confidence-bar bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full" style="width: 0%"></div>
           </div>
           <p class="text-xs text-gray-600 mt-2 text-center">High confidence match detected</p>
          </div>
         </div>
         <p id="loginScanInstruction" class="text-gray-600 text-center mb-6 px-4">Position your face in the frame for quick and secure access</p><button id="loginScanBtn" class="w-full bg-gradient-to-r from-blue-900 to-blue-800 text-white py-4 px-8 rounded-xl font-semibold hover:from-blue-800 hover:to-blue-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg> Start Face Scan </button>
        </div>
       </div>
       <div class="text-center pt-6 border-t border-gray-200"><button id="backToLanding" class="text-gray-600 hover:text-gray-800 font-medium underline"> ← Back to Home </button>
       </div>
      </div><div id="registerContent" class="p-12 flex-col justify-center hidden">
       <div class="mb-8">
        <h2 id="registerTitle" class="text-3xl font-bold text-gray-800 mb-2">Create Account</h2>
        <p class="text-gray-500">Join us and manage your health better</p>
       </div>
       <form id="registerForm" class="space-y-6">
        <div><label for="fullName" class="block text-sm font-semibold text-gray-700 mb-2">Full Name</label>
         <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
           <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
           </svg>
          </div><input type="text" id="fullName" required class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-900 focus:border-blue-900 outline-none transition-all" placeholder="Enter your full name">
         </div>
        </div>
        <div><label for="birthDate" class="block text-sm font-semibold text-gray-700 mb-2">Date of Birth</label>
         <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
           <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
           </svg>
          </div><input type="date" id="birthDate" required class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-900 focus:border-blue-900 outline-none transition-all">
         </div>
        </div><button type="submit" id="continueToScan" class="w-full bg-gradient-to-r from-yellow-900 to-yellow-800 text-white py-4 px-8 rounded-xl font-semibold hover:from-yellow-800 hover:to-yellow-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center"> Continue to Face Scan 
         <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
         </svg></button>
       </form>
       <div class="text-center pt-6 border-t border-gray-200 mt-6"><button id="backToLandingFromRegister" class="text-gray-600 hover:text-gray-800 font-medium underline"> ← Back to Home </button>
       </div>
      </div>
     </div>
    </div>
   </main><main id="scanPage" class="w-full max-w-5xl hidden">
    <div class="bg-white rounded-3xl card-shadow p-12">
     <div class="text-center mb-12">
      <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-900 to-blue-800 rounded-full mb-4">
       <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
       </svg>
      </div>
      <h2 class="text-3xl font-bold text-gray-800 mb-2">Face Registration</h2>
      <p class="text-gray-600 text-lg">Almost there! Let's capture your face</p>
     </div>
     <div class="mb-8">
      <div class="flex flex-col items-center py-8">
       <div id="registerScanFrame" class="scan-frame w-72 h-72 flex items-center justify-center mb-8 bg-gradient-to-br from-blue-50 to-blue-100 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-16 h-16 border-t-4 border-l-4 border-blue-900"></div>
        <div class="absolute top-0 right-0 w-16 h-16 border-t-4 border-r-4 border-blue-900"></div>
        <div class="absolute bottom-0 left-0 w-16 h-16 border-b-4 border-l-4 border-blue-900"></div>
        <div class="absolute bottom-0 right-0 w-16 h-16 border-b-4 border-r-4 border-blue-900"></div>
        <video id="registerVideo" class="w-full h-full object-cover rounded-full hidden" autoplay playsinline></video>
        <svg id="registerCameraIcon" class="w-40 h-40 text-blue-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
       </div>
       <div class="max-w-md text-center mb-8">
        <p id="registerScanInstruction" class="text-gray-600 text-lg mb-4">Position your face in the frame for biometric registration</p>
        <div class="flex items-center justify-center space-x-6 text-sm text-gray-500">
         <div class="flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg> Good lighting
         </div>
         <div class="flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg> Face centered
         </div>
         <div class="flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg> No glasses
         </div>
        </div>
       </div>
       <div class="flex flex-col sm:flex-row gap-4 w-full max-w-md"><button id="registerScanBtn" class="flex-1 bg-gradient-to-r from-blue-900 to-blue-800 text-white py-4 px-8 rounded-xl font-semibold hover:from-blue-800 hover:to-blue-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center">
         <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
         </svg> Capture Photo </button> <button id="backToForm" class="flex-1 bg-gray-200 text-gray-700 py-4 px-8 rounded-xl font-semibold hover:bg-gray-300 transition-all flex items-center justify-center">
         <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
         </svg> Back to Form </button>
       </div>
      </div>
     </div>
    </div>
   </main><div id="previewModal" class="preview-modal hidden">
    <div class="preview-content">
     <div class="text-center mb-6">
      <h3 class="text-2xl font-bold text-gray-800 mb-2">Review Your Photo</h3>
      <p class="text-gray-600">Make sure your face is clearly visible</p>
     </div>
     <div class="mb-6"><img id="previewImage" src="" alt="Face Preview" class="w-full rounded-2xl shadow-lg">
     </div>
     <div class="flex gap-4"><button id="retakeBtn" class="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-all">
       <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
       </svg> Retake </button> <button id="confirmPhotoBtn" class="flex-1 bg-gradient-to-r from-green-600 to-green-500 text-white py-3 px-6 rounded-xl font-semibold hover:from-green-500 hover:to-green-400 transition-all">
       <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
       </svg> Confirm &amp; Register </button>
     </div>
    </div>
   </div><main id="successPage" class="w-full max-w-md hidden">
    <div class="bg-white rounded-2xl card-shadow p-8 text-center">
     <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-6 checkmark-animation">
      <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
     </div>
     <h2 class="text-2xl font-bold text-gray-800 mb-3">Welcome!</h2>
     <p id="welcomeName" class="text-gray-600 mb-8">You have successfully logged in</p><button id="logoutBtn" class="bg-gradient-to-r from-blue-900 to-blue-800 text-white py-3 px-8 rounded-lg font-medium hover:from-blue-800 hover:to-blue-700 transition-all"> Logout </button>
    </div>
   </main>
  </div><audio id="countdownSound" preload="auto"><source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLXiTcIGWi77eefTRAMUKfj8LZjHAY4ktfyzHksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgc7y14k3CBlou+3nn00QDFCn4/C2YxwGOJLX8sx5LAUkd8fw7ZBAChRetOvrqFUUCkaf4PK+bCEFK4HO8teJNwgZaLvt559NEAxQp+PwtmMcBjiS1/LMeSwFJHfH8N2QQAoUXrTr66hVFApGn+DyvmwhBSuBzvLXiTcIGWi77eefTRAMUKfj8LZjHAY4ktfyzHksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgc7y14k3CBlou+3nn00QDFCn4/C2YxwGOJLX8sx5LAUkd8fw7ZBAChRetOvrqFUUCkaf4PK+bCEFK4HO8teJNwgZaLvt559NEAxQp+PwtmMcBjiS1/LMeSwFJHfH8N2QQAoUXrTr66hVFApGn+DyvmwhBSuBzvLXiTcIGWi77eefTRAMUKfj8LZjHAY4ktfyzHksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQA=" type="audio/wav">
  </audio>
  <audio id="captureSound" preload="auto"><source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLXiTcIGWi77eefTRAMUKfj8LZjHAY4ktfyzHksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgc7y14k3CBlou+3nn00QDFCn4/C2YxwGOJLX8sx5LAUkd8fw7ZBAChRetOvrqFUUCkaf4PK+bCEFK4HO8teJNwgZaLvt559NEAxQp+PwtmMcBjiS1/LMeSwFJHfH8N2QQAoUXrTr66hVFApGn+DyvmwhBSuBzvLXiTcIGWi77eefTRAMUKfj8LZjHAY4ktfyzHksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgc7y14k3CBlou+3nn00QDFCn4/C2YxwGOJLX8sx5LAUkd8fw7ZBAChRetOvrqFUUCkaf4PK+bCEFK4HO8teJNwgZaLvt559NEAxQp+PwtmMcBjiS1/LMeSwFJHfH8N2QQAoUXrTr66hVFApGn+DyvmwhBSuBzvLXiTcIGWi77eefTRAMUKfj8LZjHAY4ktfyzHksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQA=" type="audio/wav">
  </audio>
  <audio id="successSound" preload="auto"><source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhQA=" type="audio/wav">
  </audio>
  <script>
    const defaultConfig = {
      background_color: "#1e3a8a",
      card_color: "#ffffff",
      text_color: "#1f2937",
      primary_action_color: "#1e3a8a",
      secondary_action_color: "#b45309",
      font_family: "Inter",
      font_size: 16,
      app_title: "MediScan AI",
      app_tagline: "Your Health, Our Priority",
      login_title: "Welcome Back",
      register_title: "Create Account",
      scan_instruction: "Position your face in the frame"
    };

    let registrationData = {};
    let users = [];
    let loginStream = null;
    let registerStream = null;
    let currentMode = 'landing';
    let capturedPhoto = null;
    let soundEnabled = true; // Toggle for sound effects

    const dataHandler = {
      onDataChanged(data) {
        users = data;
      }
    };

    async function startCamera(videoElement, iconElement) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } 
        });
        videoElement.srcObject = stream;
        videoElement.classList.remove('hidden');
        iconElement.classList.add('hidden');
        return stream;
      } catch (error) {
        showToast('Camera access denied or not available', 'error');
        return null;
      }
    }

    function stopCamera(stream) {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    }

    async function captureFrame(videoElement) {
      const canvas = document.createElement('canvas');
      canvas.width = videoElement.videoWidth;
      canvas.height = videoElement.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoElement, 0, 0);
      return canvas.toDataURL('image/jpeg', 0.8);
    }

    function playSound(soundId) {
      if (soundEnabled) {
        const sound = document.getElementById(soundId);
        if (sound) {
          sound.currentTime = 0;
          sound.play().catch(() => {}); // Silently fail if audio not supported
        }
      }
    }

    function showFlashEffect() {
      const flash = document.createElement('div');
      flash.className = 'flash-effect';
      document.body.appendChild(flash);
      setTimeout(() => flash.remove(), 500);
    }

    async function showCountdown(containerElement) {
      for (let i = 3; i > 0; i--) {
        const countdown = document.createElement('div');
        countdown.className = 'countdown';
        countdown.textContent = i;
        containerElement.appendChild(countdown);
        playSound('countdownSound');
        await new Promise(resolve => setTimeout(resolve, 1000));
        countdown.remove();
      }
    }

    function showPhotoPreview(imageData) {
      document.getElementById('previewImage').src = imageData;
      document.getElementById('previewModal').classList.remove('hidden');
    }

    function hidePhotoPreview() {
      document.getElementById('previewModal').classList.add('hidden');
    }

    function showConfidenceAnimation(percent) {
      const display = document.getElementById('loginConfidenceDisplay');
      const bar = document.getElementById('loginConfidenceBar');
      const percentText = document.getElementById('loginConfidencePercent');
      
      display.classList.remove('hidden');
      percentText.textContent = `${percent}%`;
      
      setTimeout(() => {
        bar.style.width = `${percent}%`;
      }, 100);
    }

    async function init() {
      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          showToast("Failed to initialize data storage", "error");
        }
      }

      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
        await onConfigChange(window.elementSdk.config || defaultConfig);
      }
    }

    async function onConfigChange(config) {
      const finalConfig = { ...defaultConfig, ...config };
      const customFont = finalConfig.font_family || defaultConfig.font_family;
      const baseFontSize = finalConfig.font_size || defaultConfig.font_size;
      const bgColor = finalConfig.background_color || defaultConfig.background_color;
      const cardColor = finalConfig.card_color || defaultConfig.card_color;
      const textColor = finalConfig.text_color || defaultConfig.text_color;
      const primaryColor = finalConfig.primary_action_color || defaultConfig.primary_action_color;
      const secondaryColor = finalConfig.secondary_action_color || defaultConfig.secondary_action_color;

      const baseFontStack = 'Inter, -apple-system, BlinkMacSystemFont, sans-serif';
      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;

      document.getElementById('app').style.background = `linear-gradient(135deg, ${bgColor} 0%, ${primaryColor} 100%)`;
      
      const cards = document.querySelectorAll('.bg-white, .card-shadow');
      cards.forEach(card => {
        if (!card.classList.contains('gradient-bg')) {
          card.style.backgroundColor = cardColor;
        }
      });

      const titles = ['appTitle', 'mainTitle'];
      titles.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.style.color = '#ffffff';
          el.style.fontSize = `${baseFontSize * 2.5}px`;
          el.textContent = finalConfig.app_title || defaultConfig.app_title;
        }
      });

      const taglines = ['appTagline', 'mainTagline'];
      taglines.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.style.color = '#ffffff';
          el.style.fontSize = `${baseFontSize * 1.25}px`;
          el.textContent = finalConfig.app_tagline || defaultConfig.app_tagline;
        }
      });

      const loginTitleEl = document.getElementById('loginTitle');
      if (loginTitleEl) {
        loginTitleEl.style.color = textColor;
        loginTitleEl.style.fontSize = `${baseFontSize * 1.875}px`;
        loginTitleEl.textContent = finalConfig.login_title || defaultConfig.login_title;
      }

      const registerTitleEl = document.getElementById('registerTitle');
      if (registerTitleEl) {
        registerTitleEl.style.color = textColor;
        registerTitleEl.style.fontSize = `${baseFontSize * 1.875}px`;
        registerTitleEl.textContent = finalConfig.register_title || defaultConfig.register_title;
      }

      const scanInstructions = ['loginScanInstruction', 'registerScanInstruction'];
      scanInstructions.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.style.color = textColor;
          el.style.fontSize = `${baseFontSize}px`;
          el.textContent = finalConfig.scan_instruction || defaultConfig.scan_instruction;
        }
      });

      const primaryBtns = document.querySelectorAll('#loginScanBtn, #logoutBtn, #loginCard button, #loginTab');
      primaryBtns.forEach(btn => {
        btn.style.background = `linear-gradient(to right, ${primaryColor}, #1e40af)`;
        btn.style.fontSize = `${baseFontSize}px`;
      });

      const secondaryBtns = document.querySelectorAll('#backToForm, #continueToScan, #registerCardMain button');
      secondaryBtns.forEach(btn => {
        btn.style.background = `linear-gradient(to right, ${secondaryColor}, #92400e)`;
        btn.style.fontSize = `${baseFontSize}px`;
      });

      const scanFrames = document.querySelectorAll('.scan-frame');
      scanFrames.forEach(frame => {
        frame.style.borderColor = primaryColor;
      });

      const labels = document.querySelectorAll('label');
      labels.forEach(label => {
        label.style.fontSize = `${baseFontSize * 0.875}px`;
        label.style.color = textColor;
      });

      const inputs = document.querySelectorAll('input');
      inputs.forEach(input => {
        input.style.fontSize = `${baseFontSize}px`;
      });
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ background_color: value });
              }
            }
          },
          {
            get: () => config.card_color || defaultConfig.card_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ card_color: value });
              }
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ text_color: value });
              }
            }
          },
          {
            get: () => config.primary_action_color || defaultConfig.primary_action_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ primary_action_color: value });
              }
            }
          },
          {
            get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ secondary_action_color: value });
              }
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            if (window.elementSdk) {
              window.elementSdk.setConfig({ font_family: value });
            }
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            if (window.elementSdk) {
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["app_title", config.app_title || defaultConfig.app_title],
        ["app_tagline", config.app_tagline || defaultConfig.app_tagline],
        ["login_title", config.login_title || defaultConfig.login_title],
        ["register_title", config.register_title || defaultConfig.register_title],
        ["scan_instruction", config.scan_instruction || defaultConfig.scan_instruction]
      ]);
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}-toast`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function updateWizardStep(step) {
      ['wizardStep1', 'wizardStep2', 'wizardStep3'].forEach((id, index) => {
        const circle = document.getElementById(id);
        const text = document.getElementById(id + 'Text');
        const label = document.getElementById(id + 'Label');
        
        if (index + 1 <= step) {
          circle.classList.remove('step-inactive');
          circle.classList.add('step-active');
          text.style.color = '#1e3a8a';
          label.classList.add('step-text-active');
        } else {
          circle.classList.remove('step-active');
          circle.classList.add('step-inactive');
          text.style.color = '#ffffff';
          label.classList.remove('step-text-active');
        }
      });

      const line1 = document.getElementById('wizardLine1');
      const line2 = document.getElementById('wizardLine2');
      
      if (step >= 2) {
        line1.style.borderColor = 'white';
        line1.style.opacity = '1';
      } else {
        line1.style.opacity = '0.5';
      }

      if (step >= 3) {
        line2.style.borderColor = 'white';
        line2.style.opacity = '1';
      } else {
        line2.style.opacity = '0.3';
      }
    }

    function showPage(pageId) {
      const pages = ['landingPage', 'loginPage', 'scanPage', 'successPage'];
      pages.forEach(id => {
        const page = document.getElementById(id);
        if (page) {
          if (id === pageId) {
            page.classList.remove('hidden');
            page.classList.add('slide-enter');
          } else {
            page.classList.add('hidden');
            page.classList.remove('slide-enter');
          }
        }
      });

      if (pageId !== 'loginPage' && loginStream) {
        stopCamera(loginStream);
        loginStream = null;
        document.getElementById('loginVideo').classList.add('hidden');
        document.getElementById('loginCameraIcon').classList.remove('hidden');
        document.getElementById('loginConfidenceDisplay').classList.add('hidden');
      }
      if (pageId !== 'scanPage' && registerStream) {
        stopCamera(registerStream);
        registerStream = null;
        document.getElementById('registerVideo').classList.add('hidden');
        document.getElementById('registerCameraIcon').classList.remove('hidden');
      }

      if (pageId === 'landingPage') {
        updateWizardStep(1);
      } else if (pageId === 'loginPage') {
        updateWizardStep(2);
      } else if (pageId === 'scanPage') {
        updateWizardStep(3);
      }
    }

    function switchTab(tab) {
      const loginTab = document.getElementById('loginTab');
      const registerTabBtn = document.getElementById('registerTabBtn');
      const loginContent = document.getElementById('loginContent');
      const registerContent = document.getElementById('registerContent');

      if (tab === 'login') {
        loginTab.classList.add('text-blue-900', 'border-b-4', 'border-blue-900', 'bg-blue-50');
        loginTab.classList.remove('text-gray-500');
        registerTabBtn.classList.add('text-gray-500');
        registerTabBtn.classList.remove('text-blue-900', 'border-b-4', 'border-blue-900', 'bg-blue-50');
        
        loginContent.classList.remove('hidden');
        loginContent.classList.add('flex');
        registerContent.classList.add('hidden');
        registerContent.classList.remove('flex');
      } else {
        registerTabBtn.classList.add('text-blue-900', 'border-b-4', 'border-blue-900', 'bg-blue-50');
        registerTabBtn.classList.remove('text-gray-500');
        loginTab.classList.add('text-gray-500');
        loginTab.classList.remove('text-blue-900', 'border-b-4', 'border-blue-900', 'bg-blue-50');
        
        registerContent.classList.remove('hidden');
        registerContent.classList.add('flex');
        loginContent.classList.add('hidden');
        loginContent.classList.remove('flex');
      }
    }

    // Landing page - Login card click
    document.getElementById('loginCard').addEventListener('click', () => {
      showPage('loginPage');
      switchTab('login');
    });

    // Landing page - Register card click
    document.getElementById('registerCardMain').addEventListener('click', () => {
      showPage('loginPage');
      switchTab('register');
    });

    // Tab switching
    document.getElementById('loginTab').addEventListener('click', () => {
      switchTab('login');
    });

    document.getElementById('registerTabBtn').addEventListener('click', () => {
      switchTab('register');
    });

    // Back to landing buttons
    document.getElementById('backToLanding').addEventListener('click', () => {
      showPage('landingPage');
    });

    document.getElementById('backToLandingFromRegister').addEventListener('click', () => {
      showPage('landingPage');
    });

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fullName = document.getElementById('fullName').value.trim();
      const birthDate = document.getElementById('birthDate').value;

      if (!fullName || !birthDate) {
        showToast('Please fill in all fields', 'error');
        return;
      }

      registrationData = { fullName, birthDate };
      showPage('scanPage');
    });

    document.getElementById('backToForm').addEventListener('click', () => {
      showPage('loginPage');
      switchTab('register');
    });

    // Register scan button with countdown and preview
    document.getElementById('registerScanBtn').addEventListener('click', async () => {
      const btn = document.getElementById('registerScanBtn');
      const frame = document.getElementById('registerScanFrame');
      const video = document.getElementById('registerVideo');
      const icon = document.getElementById('registerCameraIcon');
      
      btn.disabled = true;
      btn.classList.add('btn-disabled');
      btn.innerHTML = '<span class="spinner"></span>Starting Camera...';

      if (users.length >= 999) {
        showToast('Maximum limit of 999 users reached', 'error');
        btn.disabled = false;
        btn.classList.remove('btn-disabled');
        btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>Capture Photo';
        return;
      }

      if (!registerStream) {
        registerStream = await startCamera(video, icon);
        if (!registerStream) {
          btn.disabled = false;
          btn.classList.remove('btn-disabled');
          btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>Capture Photo';
          return;
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      // Countdown
      btn.innerHTML = '<span class="spinner"></span>Get Ready...';
      await showCountdown(frame);

      // Capture
      playSound('captureSound');
      showFlashEffect();
      frame.classList.add('scanning');
      capturedPhoto = await captureFrame(video);
      
      setTimeout(() => {
        frame.classList.remove('scanning');
        showPhotoPreview(capturedPhoto);
      }, 500);

      btn.disabled = false;
      btn.classList.remove('btn-disabled');
      btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>Capture Photo';
    });

    // Retake photo
    document.getElementById('retakeBtn').addEventListener('click', () => {
      hidePhotoPreview();
      capturedPhoto = null;
    });

    // Confirm and register
    document.getElementById('confirmPhotoBtn').addEventListener('click', async () => {
      const btn = document.getElementById('confirmPhotoBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Registering...';

      const newUser = {
        user_id: `user_${Date.now()}`,
        full_name: registrationData.fullName,
        birth_date: registrationData.birthDate,
        face_data: capturedPhoto,
        registered_at: new Date().toISOString()
      };
      
      let registrationSuccess = false;

      if (window.dataSdk) {
        const result = await window.dataSdk.create(newUser);
        registrationSuccess = result.isOk;
      } else {
        // Mode Non-SDK: Asumsi sukses untuk pengujian UI.
        registrationSuccess = true; 
      }

      if (registrationSuccess) {
        // SIMPAN FOTO WAJAH ASLI YANG BARU DIAMBIL SAAT REGISTER
        localStorage.setItem('activePatientPhoto', capturedPhoto);
        localStorage.setItem('activePatientName', newUser.full_name);
        localStorage.setItem('activePatientBirthDate', newUser.birth_date); 
        localStorage.setItem('activePatientEmotion', 'Senang'); // Simulasikan emosi saat registrasi

        hidePhotoPreview();
        stopCamera(registerStream);
        registerStream = null;
        document.getElementById('registerVideo').classList.add('hidden');
        document.getElementById('registerCameraIcon').classList.remove('hidden');
        
        playSound('successSound');
        showToast('Registration successful! Redirecting...', 'success');
        
        // Pengalihan ke Dashboard
        setTimeout(() => {
            window.location.href = 'index.html'; 
        }, 1000); 
      } else {
          // Hanya jika SDK ada dan gagal
          showToast('Registration failed. Please try again.', 'error');
      }

      btn.disabled = false;
      btn.innerHTML = '<svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Confirm & Register';
      registrationData = {};
      capturedPhoto = null;
    });

    // Login scan with confidence display
    document.getElementById('loginScanBtn').addEventListener('click', async () => {
      const btn = document.getElementById('loginScanBtn');
      const frame = document.getElementById('loginScanFrame');
      const video = document.getElementById('loginVideo');
      const icon = document.getElementById('loginCameraIcon');
      
      btn.disabled = true;
      btn.classList.add('btn-disabled');
      btn.innerHTML = '<span class="spinner"></span>Starting Camera...';

      if (!loginStream) {
        loginStream = await startCamera(video, icon);
        if (!loginStream) {
          btn.disabled = false;
          btn.classList.remove('btn-disabled');
          btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>Start Face Scan';
          return;
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      // Countdown
      btn.innerHTML = '<span class="spinner"></span>Get Ready...';
      await showCountdown(frame);

      // Scanning
      btn.innerHTML = '<span class="spinner"></span>Scanning...';
      playSound('captureSound');
      showFlashEffect();
      frame.classList.add('scanning');
      
      // --- START PEMBARUAN: AMBIL FOTO DARI KAMERA SAAT LOGIN ---
      let loginCapturedPhoto = await captureFrame(video);
      await new Promise(resolve => setTimeout(resolve, 1000));
      // --- END PEMBARUAN ---

      frame.classList.remove('scanning');

      stopCamera(loginStream);
      loginStream = null;
      video.classList.add('hidden');
      icon.classList.remove('hidden');

      if (users.length === 0 && window.dataSdk) {
        showToast('No registered users. Please register first.', 'error');
        btn.disabled = false;
        btn.classList.remove('btn-disabled');
        btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>Start Face Scan';
        return;
      }
      
      // Asumsi login sukses di non-SDK mode.
      const confidence = Math.floor(Math.random() * (99 - 92 + 1)) + 92; 
      showConfidenceAnimation(confidence);
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // --- START PEMBARUAN: SIMPAN FOTO ASLI YANG DIAMBIL SAAT LOGIN ---
      localStorage.setItem('activePatientPhoto', loginCapturedPhoto);
      localStorage.setItem('activePatientName', 'User Login Aktif');
      localStorage.setItem('activePatientBirthDate', '1990-01-01'); 
      localStorage.setItem('activePatientEmotion', 'Tenang'); 
      // --- END PEMBARUAN

      playSound('successSound');
      showToast(`Login successful! Redirecting...`, 'success');
      
      // Pengalihan ke Dashboard
      setTimeout(() => {
          window.location.href = 'index.html'; 
      }, 1000); 

      btn.disabled = false;
      btn.classList.remove('btn-disabled');
      btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>Start Face Scan';
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      showPage('landingPage');
      showToast('Logged out successfully', 'success');
    });

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a1f6ce1f6be4ad1',t:'MTc2MzcyMDEyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>